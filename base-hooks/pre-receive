#!/bin/bash

source /opt/git-deploy/base-hooks/helpers.sh

while read oldrev newrev refname; do
	setup_env "$newrev"
	if [ -f "$HOOK_DIR/pre-receive" ]; then
		if [ "${CAPTURE_OUTPUT}" == "true" ]; then
			echo "$oldrev" "$newrev" "$refname" \
				| timeout -k "$DEPLOY_TIMEOUT_KILL" "$DEPLOY_TIMEOUT_TERM" bash "$HOOK_DIR/pre-receive" 2>&1 \
				| tee /var/log/git-deploy/hooks.log
		else
			echo "$oldrev" "$newrev" "$refname" \
				| timeout -k "$DEPLOY_TIMEOUT_KILL" "$DEPLOY_TIMEOUT_TERM" bash "$HOOK_DIR/pre-receive"
		fi
	fi
done

#!/bin/bash
source ~/.profile

REPO_NAME=$1

if [ -z "$1" ]; then
	echo "usage: mkrepo repo-name"
	exit 1
fi

# Create repo
mkdir -p /git/${REPO_NAME}.git
cd /git/${REPO_NAME}.git
git init

#allow working tree to be checked out on receive
git config --bool receive.denyCurrentBranch false

# Populate new repos with a base 'proxy' hook.
# On receiving a new push this will make a rpos:
# 1. Update the working tree
# 2. Run the latest '/hooks/post-receive' script from the latest HEAD
cat <<- EOF > .git/hooks/post-receive
	#!/bin/bash
	source /git/.profile
	cd ..
	env -i git reset --hard
	backup
	if [ -f ./hooks/post-receive ]; then
		bash ./hooks/post-receive
	fi
EOF
chmod +x .git/hooks/post-receive

# Backup addition of new repo
cd /git
backup
